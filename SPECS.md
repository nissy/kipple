# Kipple 機能仕様書

## 概要
Kipple は macOS 向けのクリップボードマネージャーアプリケーションです。メニューバーに常駐し、クリップボード履歴の管理、テキスト編集、自動カテゴリ分類などの機能を提供します。

## アーキテクチャ
- **Clean Architecture + MVVM パターン**
- **SwiftUI ベースの UI**
- **XcodeGen によるプロジェクト生成**
- **レイヤー構造**: App層、Presentation層、Domain層、Data層、Infrastructure層

## 主要機能

### 1. メニューバーアプリケーション
- **常駐型アプリ**: メニューバーに常駐、クリックでメニュー表示
- **メニューアイコン**: "doc.on.clipboard" システムシンボル
- **メニュー項目**:
  - About: アプリ情報画面
  - Open Kipple: メインウィンドウを開く
  - Grant Accessibility Permission: アクセシビリティ権限の確認/設定
  - Preferences: 設定画面
  - Developer Settings: 開発者設定（DEBUGビルドのみ）
  - Quit Kipple: アプリ終了

### 2. クリップボード監視機能
- **自動監視**: 0.5秒間隔でクリップボード変更を検出
- **テキスト取得**: テキストデータのみ履歴に保存
- **重複管理**: 
  - 同じ内容の場合は既存アイテムを最上位に移動
  - ハッシュセットによる高速重複チェック
- **サイズ制限**: 10MB以上のコンテンツは除外
- **アプリ情報取得**:
  - コピー元アプリ名（Kipple自身の場合は最後のアクティブアプリ）
  - ウィンドウタイトル（アクセシビリティ権限がある場合）
  - バンドルID、プロセスID

### 3. 履歴管理機能
- **履歴保存**: 
  - デフォルト最大100アイテム（設定で10-1000に変更可能）
  - Core Data（SQLite）に保存
- **ピン留め機能**:
  - 重要なアイテムをピン留め
  - デフォルト最大10アイテム（設定で1-100に変更可能）
  - 履歴クリア時もピン留めアイテムは保持
- **個別削除**: ホバー時の×ボタンで削除（ピン留め除く）

### 4. クイックエディター機能
- **テキストエディタ**: 
  - 自由にテキスト入力・編集可能
  - 最後の編集内容を自動保存・復元
  - 複数行対応
- **固定行高エディタ（FixedLineHeightEditor）**:
  - 日本語入力時も行高が変動しない
  - CJKフォントに最適化された行高計算
  - NSLayoutManagerDelegateによる精密な制御
- **行番号表示**:
  - 左側に行番号を表示
  - スクロールに同期

### 5. メインウィンドウ UI

#### ウィンドウ管理
- **フローティングウィンドウ**: 常に最前面レベル
- **カーソル位置表示**: マウス位置に表示（画面端で自動調整）
- **自動クローズ**: フォーカスを失うと閉じる（Always on Top無効時）
- **サイズ**: 
  - デフォルト: 420×600
  - 最小: 300×300、最大: 800×1200
  - サイズ変更時に自動保存

#### レイアウト構造
- **ResizableSplitView**: ドラッグ可能な上下分割ビュー
  - エディターセクション（デフォルト上部）
  - 履歴セクション（デフォルト下部）
  - 中央のドラッグハンドルで高さ調整可能
- **エディター位置切り替え**: 設定で上下入れ替え可能

#### アニメーション
- **ウィンドウ表示アニメーション**:
  - fade: フェードイン（デフォルト）
  - scale: 拡大アニメーション
  - slide: スライドアップ
  - none: アニメーションなし

### 6. カテゴリ分類機能
コンテンツに基づいて自動分類：

- **URL**: HTTPスキーマまたはドメイン形式（例: example.com）
- **Email**: メールアドレス形式
- **Code**: プログラミング言語の構文を含む
- **File Path**: ファイルパス形式（Unix/Windows対応）
- **Short Text**: 50文字以下
- **Long Text**: 1000文字以上
- **General**: 51-999文字で他カテゴリに該当しない
- **Kipple**: エディターからコピーされたテキスト

### 7. フィルタリング機能
- **カテゴリフィルター**: 
  - 左サイドバーにカテゴリボタン
  - クリックで該当カテゴリのみ表示
  - 設定で各カテゴリの表示/非表示を制御
- **ピン留めフィルター**: ピン留めアイテムのみ表示
- **検索機能**: 履歴セクション上部の検索バー
  - リアルタイム検索（300msデバウンス）
  - 大文字小文字を区別しない

### 8. ホットキー機能

#### メインホットキー
- **デフォルト**: Control+V（初期状態で無効）
- **機能**: メインウィンドウの表示/非表示

#### エディターコピーホットキー
- **デフォルト**: Cmd+S（初期状態で無効）
- **機能**: エディター内容をコピーしてクリア
- **ウィンドウ非表示時も動作**

#### エディタークリアホットキー
- **デフォルト**: Cmd+L（初期状態で無効）
- **機能**: エディター内容をクリア
- **ウィンドウ非表示時も動作**

### 9. 履歴アイテムの操作

#### 基本操作
- **クリック**: クリップボードにコピー
- **エディター挿入**: 修飾キー＋クリックでエディターに挿入
  - デフォルト: Cmd+クリック（設定で変更可能）

#### アクション実行（アクション可能カテゴリのみ）
- **URL**: ブラウザで開く
- **Email**: メールクライアントで新規作成
- **File Path**: Finderで表示
- **実行方法**: カテゴリアイコンクリックまたはEnterキー

#### ポップオーバー表示
- **ホバー0.3秒後**: 詳細情報ポップオーバー
  - カテゴリ、アプリ情報、ウィンドウ情報
  - 最大500文字、10行まで表示
  - 文字数、コピー時刻
- **スクロール中は非表示**

### 10. ウィンドウ制御機能

#### Always on Top モード
- **切り替え**: 下部バーのピンアイコン
- **有効時**: フォーカスを失っても閉じない
- **無効時**: フォーカスを失うと自動的に閉じる

#### コピー通知
- **表示条件**: 
  - エディターからコピー時（常に表示）
  - Always on Top有効時の履歴コピー
- **種類**:
  - "Copied!": コピー成功
  - "Pin limit reached": ピン留め上限
- **2秒後に自動フェードアウト**

#### 下部バー
- **現在のクリップボード内容表示**
- **設定ボタン**: 歯車アイコン
- **Always on Topトグル**: ピンアイコン

### 11. 設定画面

#### General（一般設定）
- **Launch at login**: ログイン時自動起動
- **Global Hotkey**: メインホットキー設定
- **Editor Insert**: 修飾キー設定（Cmd/Option/Control/Shift）
- **Window Animation**: 表示アニメーション選択

#### Editor（エディター設定）
- **フォント設定**: SimpleFontSettingsView
  - プライマリフォント選択
  - フォールバックフォント追加（複数可）
  - フォントサイズ設定
- **Editor Position**: 上/下配置
- **エディターホットキー設定**

#### Clipboard（データ設定）
- **履歴フォント設定**: ClipboardFontSettingsView
- **Category Filter Settings**: 各カテゴリの表示/非表示
- **Storage Limits**:
  - Maximum History Items: 10-1000
  - Maximum Pinned Items: 1-100
- **Data Management**: 履歴クリア（ピン留め保持）

### 12. フォント管理システム

#### FontManager
- **エディター用と履歴用を個別管理**
- **フォールバックチェーン対応**
- **日本語フォント優先表示**

#### FontSettings
- **プライマリ＋フォールバックフォント**
- **カスケードリスト自動構築**
- **システムフォント対応**

#### 固定行高計算
- **CJKフォント対応**: 実際の描画フォントで計算
- **最大高さ×1.7倍の余白確保**
- **最小値保証**: フォントサイズ×1.6倍

### 13. アクセシビリティ機能
- **権限チェック**: キャッシュ付き（1秒間有効）
- **権限用途**:
  - アプリ名取得
  - ウィンドウタイトル取得
- **権限なしでの代替**: CGWindowList API使用
- **定期的な権限状態監視**（5秒間隔）

### 14. パフォーマンス最適化
- **ハッシュセット**: 最近50件の高速重複チェック
- **デバウンス処理**:
  - エディター保存: 500ms
  - 履歴保存: 1秒
  - 検索: 300ms
  - フォント変更: 500ms
- **LazyVStack**: 履歴リストの遅延読み込み
- **固定高さアイテム**: 36px固定でレイアウト計算削減
- **Core Dataインデックス**:
  - timestamp: 降順インデックス（ソート高速化）
  - isPinned: 降順インデックス（フィルタリング高速化）

### 15. データ永続化
- **Core Data使用**:
  - クリップボード履歴（設定に応じて10-1000件を保存）
  - SQLiteベースの効率的なストレージ
  - 非同期処理によるUIブロッキング回避
  - バックグラウンドコンテキストでの保存処理
- **UserDefaults使用**:
  - エディターテキスト
  - 各種設定値（フォント、ホットキー、UI設定など）
- **エラーハンドリング**:
  - 破損データの自動クリア
  - Core Data初期化エラーの適切な処理

### 16. ログ機能
- **Loggerクラス**:
  - log, debug, warning, error の4レベル
  - タイムスタンプ付きコンソール出力
  - OSLogを使用した構造化ログ

### 17. ビルドシステム
- **Makefile**:
  - `make generate`: XcodeGen実行
  - `make build-dev`: 開発ビルド
  - `make run`: アプリ実行
  - `make test`: テスト実行
  - `make lint`: SwiftLint実行
  - `make build`: リリースビルド
  - `make release`: DMG作成
- **バージョン管理**: VERSIONファイル

## 技術仕様
- **最小OS**: macOS 13.0以降
- **フレームワーク**: SwiftUI, AppKit, Carbon（ホットキー）
- **アーキテクチャ**: Clean Architecture + MVVM
- **依存管理**: Swift Package Manager
- **コード署名**: Developer ID（配布時）