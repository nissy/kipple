# ペーストキューモード仕様

## 概要
- 選択した履歴を指定順でペーストする「ペーストキュー」機能を追加する。
- CMDを押しながらクリック、または Shift+CMD の範囲選択で履歴を採番し、ペースト順序を積み上げる。
- キュー状態は既存の履歴モデル上で並び順・採番情報を再構成して表現し、別コレクションは持たない。
- 採番中はペーストキューモードとなり、解除操作または全ペースト完了まで継続する。

## ペーストキューモードの挙動
- CMD+クリックで対象履歴を採番し、数値バッジを表示した上で既存履歴モデル上のキュー番号 1 として扱う。
- 引き続き CMD+クリックすると採番番号をインクリメントし、既存キューの末尾に順番通り（1 → 2 → 3 → …）積み上げて履歴順序を更新する。
- Shift+CMD+クリックは範囲選択として扱い、範囲内の履歴を連番で採番する新規挙動を追加する。
- 採番した履歴をすべてペーストするか、解除ボタンを押すまでモードを維持する。
- ペーストキュートグルモード中に 1 番の履歴をペーストした際は、その履歴を末尾へ再採番してキューを保つ。
- Queue 処理中は `ModernClipboardService.recopyFromHistory` の呼び出し順を採番シーケンスに合わせ、フィルタリセットなど既存フローを抑制する。
- キューが有効な間は ⌘V を監視し、ペーストが発生したら次のアイテムをクリップボードへ準備する。権限が無くてもアプリ内で機能し、取得済みならバックグラウンドでも動作する。

## モード切り替え
- メインパネルのペーストキューボタンは「クリップボード → ペーストキュー → ペーストキュートグル」の順でトグル切り替えする。
- トグル状態に応じて UI 表示・ペーストロジック・キュー管理 API を更新する。
- Queue/Toggle モードではウィンドウを閉じず、キューが空になるか解除されるまで状態を保持する。ペースト入力はボタンではなく ⌘V によって進行する。

## UX/UI 要件
- 採番中の履歴には明確な数値バッジを表示し、現在の順序をユーザーに提示する。
- ペーストキューモード有効時には状態表示（キュー件数・次にペーストするアイテム）と解除アクションのみを提供し、「次をペースト」ボタンは設置しない。
- 解除ボタンはモード中のみアクティブとし、押下で採番リセットとモード解消を行う。
- モード切替ボタンは Copy/Clear と同列に配置し、現在のモードを常に明示する。
- Shift+CMD 範囲選択時には最後に採番したアイテムをハイライトし、連番が途切れないよう UI を更新する。

## 実装方針
- `MainViewModel` に `PasteMode` 列挙、`@Published var pasteQueue: [UUID]`、`queueBadge(for:)`、`lastQueueAnchorIndex` を追加し、`updateFilteredItems` でキュー順序を適用する。
- CMD/Shift+CMD の入力判定は `MainView.handleItemSelection` で行い、queue 操作時は通常の再コピー処理を迂回する。
- `HistoryItemView` にキュー番号バッジ描画を追加し、既存ピン・カテゴリ UI と干渉しないようレイアウトを調整する。
- ペースト実行は ⌘V 検知時にキュー先頭を取り出し、Toggle モードでは取り出し後に末尾へ再追加する。
- 自動ペースト（CGEvent 送出）は不要とし、⌘V の入力監視のみで進行させる。

## 技術タスク
- `MainViewModel` に enqueue / dequeue / reset / toggle API を実装し、Shift+CMD 範囲選択とフィルタ適用済みリスト上での採番をサポートする。
- `MainView`／`MainViewControlSection` にモードトグル、キューステータス行、解除ボタンを配置する（進行は ⌘V 監視に委ねる）。
- Command+V 監視用のモニタを実装し、権限が無い場合はローカル監視のみで動作させる。
- Queue モードのユースケースをカバーするユニットテスト（ViewModel／MockClipboardService）と UI レベルの簡易検証を追加する。

## 現状メモ
- 2025/10/18: アクセシビリティ権限未付与の場合はアプリ前面のみで ⌘V 監視が動作。権限を手動付与した環境ではバックグラウンドでも有効になる。
